#!/bin/bash
# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÛŒØ¹ Auto-Dev-LLM Ø¨Ø§ API Ø³ÙØ§Ø±Ø´ÛŒ

set -e  # ØªÙˆÙ‚Ù Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                               â•‘"
echo "â•‘         ðŸš€ Auto-Dev-LLM Quick Setup ðŸš€                       â•‘"
echo "â•‘                                                               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Ø±Ù†Ú¯â€ŒÙ‡Ø§
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
print_step() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

# Ú¯Ø§Ù… 1: Ø¨Ø±Ø±Ø³ÛŒ Python
echo "ðŸ“‹ Ú¯Ø§Ù… 1: Ø¨Ø±Ø±Ø³ÛŒ Python..."
if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version)
    print_step "Python ÛŒØ§ÙØª Ø´Ø¯: $PYTHON_VERSION"
else
    print_error "Python 3 ÛŒØ§ÙØª Ù†Ø´Ø¯! Ù„Ø·ÙØ§Ù‹ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯."
    exit 1
fi

# Ú¯Ø§Ù… 2: Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ÛŒØ· Ù…Ø¬Ø§Ø²ÛŒ
echo ""
echo "ðŸ“‹ Ú¯Ø§Ù… 2: Ù…Ø­ÛŒØ· Ù…Ø¬Ø§Ø²ÛŒ..."
if [ ! -d "venv" ]; then
    print_step "Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ÛŒØ· Ù…Ø¬Ø§Ø²ÛŒ..."
    python3 -m venv venv
else
    print_warning "Ù…Ø­ÛŒØ· Ù…Ø¬Ø§Ø²ÛŒ Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯"
fi

# ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ
source venv/bin/activate
print_step "Ù…Ø­ÛŒØ· Ù…Ø¬Ø§Ø²ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯"

# Ú¯Ø§Ù… 3: Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
echo ""
echo "ðŸ“‹ Ú¯Ø§Ù… 3: Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§..."
pip install -q --upgrade pip
pip install -q -r requirements.txt
print_step "Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯"

# Ú¯Ø§Ù… 4: Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
echo ""
echo "ðŸ“‹ Ú¯Ø§Ù… 4: Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§..."
mkdir -p specs logs backups src/core src/llm src/managers src/utils tests
print_step "Ø³Ø§Ø®ØªØ§Ø± Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯"

# Ú¯Ø§Ù… 5: ØªÙ†Ø¸ÛŒÙ… API Key
echo ""
echo "ðŸ“‹ Ú¯Ø§Ù… 5: ØªÙ†Ø¸ÛŒÙ… API Key..."

if [ -f ".env" ]; then
    print_warning ".env Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯"
    read -p "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯ØŸ (y/n): " RECONFIGURE
    if [ "$RECONFIGURE" != "y" ]; then
        RECONFIGURE="n"
    fi
else
    RECONFIGURE="y"
fi

if [ "$RECONFIGURE" = "y" ]; then
    echo ""
    echo "Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª API Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
    echo ""
    
    # Ø§Ù†ØªØ®Ø§Ø¨ provider
    echo "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:"
    echo "1) OpenRouter (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ)"
    echo "2) Anthropic Ù…Ø³ØªÙ‚ÛŒÙ…"
    echo "3) Groq (Ø±Ø§ÛŒÚ¯Ø§Ù†)"
    echo "4) Ø³Ø±ÙˆØ± Ø³ÙØ§Ø±Ø´ÛŒ"
    read -p "Ø§Ù†ØªØ®Ø§Ø¨ (1-4): " PROVIDER_CHOICE
    
    case $PROVIDER_CHOICE in
        1)
            read -p "OpenRouter API Key: " API_KEY
            API_URL="https://openrouter.ai/api/v1"
            MODEL="anthropic/claude-sonnet-4-20250514"
            ;;
        2)
            read -p "Anthropic API Key: " API_KEY
            API_URL="https://api.anthropic.com/v1"
            MODEL="claude-sonnet-4-20250514"
            ;;
        3)
            read -p "Groq API Key: " API_KEY
            API_URL="https://api.groq.com/openai/v1"
            MODEL="llama-3.1-70b-versatile"
            ;;
        4)
            read -p "Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± (Ù…Ø«Ù„Ø§Ù‹ https://api.example.com/v1): " API_URL
            read -p "API Key: " API_KEY
            read -p "Ù†Ø§Ù… Ù…Ø¯Ù„: " MODEL
            ;;
        *)
            print_error "Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø±"
            exit 1
            ;;
    esac
    
    # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± .env
    cat > .env << EOF
# API Configuration
CUSTOM_API_KEY=$API_KEY
CUSTOM_API_URL=$API_URL
CUSTOM_API_MODEL=$MODEL

# Generated by setup script
# $(date)
EOF
    
    print_step ".env Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
    
    # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ spec file
    cat > specs/self_development_spec.yaml << EOF
project_name: "auto-dev-llm-self-improvement"
description: "ØªÙˆØ³Ø¹Ù‡ Ø®ÙˆØ¯ Ø³ÛŒØ³ØªÙ…"
version: "0.2.0"

llm:
  mode: "online"
  custom_api:
    enabled: true
    base_url: "$API_URL"
    api_key_env: "CUSTOM_API_KEY"
    model: "$MODEL"
    timeout: 300
    retry: 3
  online:
    use_cache: true
    max_tokens: 3000
    temperature: 0.7
  fallback_online: false
  fallback_to_mcp: false

scheduler:
  active_hours:
    start: 0
    end: 24
  max_concurrent_tasks: 2
  check_interval: 30
  cpu_threshold: 85

cost_control:
  enabled: true
  max_cost_per_task: 0.10
  max_total_cost: 1.00
  warn_threshold: 0.50
  max_input_tokens: 2000
  max_output_tokens: 3000

git:
  auto_commit: true
  commit_message_template: "ðŸ¤– Auto: {task_name}"
  branch_pattern: "auto-dev/{feature_name}"
  auto_push: false

logging:
  log_path: "./logs"
  level: "INFO"
  per_feature_log: true

rollback:
  enabled: true
  backup_path: "./backups"
  max_backups: 20

features:
  - name: "git-automation"
    priority: 1
    description: "Git automation"
    tasks:
      - name: "git-wrapper"
        description: "Git operations wrapper"
        files: ["src/utils/git_utils.py"]
        tests: ["tests/test_git_utils.py"]
EOF
    
    print_step "spec file Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯"
fi

# Ú¯Ø§Ù… 6: ØªØ³Øª Ø§ØªØµØ§Ù„
echo ""
echo "ðŸ“‹ Ú¯Ø§Ù… 6: ØªØ³Øª Ø§ØªØµØ§Ù„..."
python3 dry_run_test.py
if [ $? -eq 0 ]; then
    print_step "ØªØ³Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!"
else
    print_warning "ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ - Ù„Ø·ÙØ§Ù‹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯"
fi

# Ú¯Ø§Ù… 7: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‡Ø²ÛŒÙ†Ù‡
echo ""
echo "ðŸ“‹ Ú¯Ø§Ù… 7: Ø¨Ø±Ø¢ÙˆØ±Ø¯ Ù‡Ø²ÛŒÙ†Ù‡..."
python3 << EOF
# Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‡Ø²ÛŒÙ†Ù‡
input_tokens = 27000
output_tokens = 45000

# Ù‚ÛŒÙ…Øª Sonnet 4.5
input_cost = (input_tokens * 3.00) / 1_000_000
output_cost = (output_tokens * 15.00) / 1_000_000
total = input_cost + output_cost

print(f"\n{'='*50}")
print(f"ðŸ’° Ø¨Ø±Ø¢ÙˆØ±Ø¯ Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡:")
print(f"{'='*50}")
print(f"Input:  {input_tokens:,} tokens Ã— \$3.00/1M  = \${input_cost:.3f}")
print(f"Output: {output_tokens:,} tokens Ã— \$15.00/1M = \${output_cost:.3f}")
print(f"{'-'*50}")
print(f"Ú©Ù„: \${total:.2f}")
print(f"{'='*50}\n")
EOF

# Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                   âœ… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯!                    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“Š Ø¢Ù…Ø§Ø± Ù¾Ø±ÙˆÚ˜Ù‡:"
echo "   â€¢ Features: 8"
echo "   â€¢ Tasks: 18"
echo "   â€¢ Files: ~36"
echo "   â€¢ Estimated time: 20-30 minutes"
echo "   â€¢ Estimated cost: ~\$0.76"
echo ""
echo "ðŸš€ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø¨Ø¹Ø¯ÛŒ:"
echo ""
echo "   1ï¸âƒ£  ØªØ³Øª Ø³Ø±ÛŒØ¹ (Ø±Ø§ÛŒÚ¯Ø§Ù†):"
echo "       python3 dry_run_test.py"
echo ""
echo "   2ï¸âƒ£  Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„:"
echo "       python3 bootstrap_self_dev.py"
echo ""
echo "   3ï¸âƒ£  Ø§Ø¬Ø±Ø§ÛŒ ÛŒÚ© feature:"
echo "       python3 main.py --batch --features git-automation"
echo ""
echo "ðŸ“– Ù…Ø³ØªÙ†Ø¯Ø§Øª:"
echo "   â€¢ COST_ESTIMATION.md"
echo "   â€¢ CUSTOM_API_SETUP.md"
echo "   â€¢ SELF_DEVELOPMENT.md"
echo ""
echo "ðŸ’¡ Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ÛŒØ· Ù…Ø¬Ø§Ø²ÛŒ:"
echo "   source venv/bin/activate"
echo ""
echo "Ø¢Ù…Ø§Ø¯Ù‡ Ù‡Ø³ØªÛŒØ¯! ðŸŽ‰"